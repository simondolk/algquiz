<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Algquiz – Södra Sverige (30 arter)</title>
  <style>
    :root{
      --brand:#0b6ea8; --accent:#0aa770; --bg:#f6f8fb; --text:#1f2937; --muted:#6b7280; --danger:#c0392b;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);}
    header{padding:1rem 1.25rem;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:5}
    h1{font-size:1.4rem;margin:.2rem 0}
    .wrap{max-width:1100px;margin:0 auto;padding:1.25rem}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:1rem}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.03);overflow:hidden}
    .imgBox{aspect-ratio:4/3;background:#eef2f7;display:flex;align-items:center;justify-content:center;position:relative}
    .imgBox img{max-width:100%;max-height:100%;object-fit:contain}
    .controls{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-top:1px solid #e5e7eb}
    button{cursor:pointer;border:none;border-radius:.5rem;background:var(--brand);color:#fff;padding:.6rem .9rem;font-weight:600}
    button.secondary{background:#eef2f7;color:#111;border:1px solid #e5e7eb}
    button.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
    .danger{background:var(--danger)}
    .ok{background:var(--accent)}
    .muted{color:var(--muted)}
    .panel{padding:1rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .row > *{margin:.15rem 0}
    input[type="text"]{width:100%;padding:.7rem .8rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem}
    .badge{display:inline-flex;align-items:center;gap:.4rem;background:#eef2f7;border:1px solid #e5e7eb;color:#374151;padding:.2rem .5rem;border-radius:.4rem;font-size:.85rem}
    .score{font-weight:700}
    .answer{margin-top:.5rem}
    .answer .correct{color:var(--accent);font-weight:700}
    .answer .wrong{color:var(--danger);font-weight:700}
    footer{padding:1rem 1.25rem;color:#6b7280}
    details{margin-top:.6rem}

    /* Flervals-rullmeny */
    .selectBox{display:flex;flex-direction:column;gap:.5rem;margin:.5rem 0}
    select{padding:.6rem .8rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem;background:#fff}

    /* Bildsnurra */
    .imgNav{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(255,255,255,.88); color:#111; border:1px solid #e5e7eb;
      width:36px; height:36px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-weight:700;
    }
    .imgNav.prev{left:.5rem}
    .imgNav.next{right:.5rem}
    .imgNav:disabled{opacity:.4; cursor:not-allowed}
    .imgCounter{
      position:absolute; right:.6rem; bottom:.5rem;
      background:rgba(0,0,0,.65); color:#fff; font-size:.85rem;
      padding:.2rem .45rem; border-radius:.4rem;
    }
  </style>
</head>
<body>

<header class="wrap">
  <h1>Algquiz</h1>
  <div class="row">
    <span class="badge">Fråga: <span id="qNum">1</span> / <span id="qTotal">1</span></span>
    <span class="badge">Poäng: <span class="score" id="score">0</span></span>
    <span class="badge">Läge: <strong id="modeLabel">Fritext</strong></span>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div class="imgBox" id="imgBox" aria-live="polite">
      <button id="imgPrevBtn" class="imgNav prev" aria-label="Föregående bild">◀</button>
      <img id="algImg" alt="Algfoto i quizet" src="" />
      <button id="imgNextBtn" class="imgNav next" aria-label="Nästa bild">▶</button>
      <div id="imgCounter" class="imgCounter" aria-live="polite">1/1</div>
    </div>
    <div class="controls">
      <button id="prevBtn" class="secondary" title="Föregående">←</button>
      <div class="row">
        <button id="showBtn" class="ghost">Visa rätt svar</button>
        <button id="checkBtn" class="">Kontrollera</button>
        <button id="nextBtn" class="ok">Nästa →</button>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="panel">
      <h2>Vad heter denna alg?</h2>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label><input type="radio" name="mode" value="text" checked> Fritext</label>
          <label><input type="radio" name="mode" value="mc"> Flervalsfråga</label>
        </div>
      </div>

      <!-- Fritext -->
      <div id="textBox">
        <input id="answerInput" type="text" placeholder="Skriv svenskt namn (latin går också bra)..." autocomplete="off" />
        <div class="answer" id="answerMsg"></div>
      </div>

      <!-- Flervalsläge (rullmeny) -->
      <div id="mcBox" style="display:none">
        <div class="selectBox">
          <label for="mcSelect" class="muted">Välj ett alternativ:</label>
          <select id="mcSelect">
            <option value="">-- Välj --</option>
          </select>
        </div>
        <div id="mcMsg" class="answer"></div>
      </div>

      <details>
        <summary>Tips</summary>
        <ul>
          <li>Endast skiftläge ignoreras och **mellanslag** accepteras (särskrivning). Inga övriga stavfel.</li>
          <li>“Visa rätt svar” avslöjar det korrekta namnet för den aktuella bilden.</li>
        </ul>
      </details>
    </div>
  </aside>
</main>

<footer class="wrap">
  <small class="muted">Byggd för undervisning: södra Sveriges vanliga makroalger (Kattegatt/Öresund). Lägg bilder i <code>/images</code> och ange filnamn under respektive art i listan i koden.</small>
</footer>

<script>
/*** =======================
 *  KONFIGURATION BILDER
 *  ======================= */
const BASE_IMAGE_URL = "https://simondolk.github.io/algquiz/images/";

/*** =======================
 *  HJÄLPLIGA FUNKTIONER
 *  ======================= */
// Ny normalisering: endast skiftläge + mellanslag (särskrivning)
const normalize = (s) => (s || "")
  .toLowerCase()
  .replace(/\s+/g, ""); // ta bort alla mellanslag, behåll allt annat

function isExactMatchWithSpaces(userInput, item){
  const cand = normalize(userInput);
  const accepted = [item.commonName, item.latinName, ...(item.aliases||[])].map(normalize);
  return accepted.includes(cand);
}

const sample = (arr, n) => {
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a.slice(0,n);
};

/*** =======================
 *  ARTLISTA (börja enkelt)
 *  ======================= */
const BANK = [
  { commonName:"Blåstång", latinName:"Fucus vesiculosus", group:"Brunalger",
    aliases:["blastang","Fucus vesiculosus"], // tillåt både svenska utan prickar och latin
    images:["blastang_1.jpg","blastang_2.jpg","blastang_3.jpg"] // byt/behåll exakt som i /images/
  }
];

// Pool för distraktorer till MC om du ännu har få arter i BANK
const DISTRACTOR_POOL = [
  "Sågtång","Spiraltång","Knöltång","Havssallat","Tarmalg","Grönslick",
  "Sockertare","Fingertare","Stortare","Kräkel","Korallalg","Ullsläke"
];

// Bygg QUIZ med fullständiga bild-URL:er
let QUIZ = BANK.map(item => ({
  ...item,
  images: (item.images||[]).map(file => BASE_IMAGE_URL + file)
}));

/*** =======================
 *  TILLSTÅND / UI
 *  ======================= */
let idx = 0;
let score = 0;
let mode = "text";

let imgIndexMap = {};

const qNum = document.getElementById("qNum");
const qTotal = document.getElementById("qTotal");
const scoreEl = document.getElementById("score");
const imgEl = document.getElementById("algImg");
const imgPrevBtn = document.getElementById("imgPrevBtn");
const imgNextBtn = document.getElementById("imgNextBtn");
const imgCounter = document.getElementById("imgCounter");
const answerInput = document.getElementById("answerInput");
const answerMsg = document.getElementById("answerMsg");
const showBtn = document.getElementById("showBtn");
const checkBtn = document.getElementById("checkBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const modeLabel = document.getElementById("modeLabel");
const mcBox = document.getElementById("mcBox");
const textBox = document.getElementById("textBox");
const mcSelect = document.getElementById("mcSelect");
const mcMsg = document.getElementById("mcMsg");

qTotal.textContent = QUIZ.length.toString();

/* ---------- Bildsnurra (oförändrad funktionalitet) ---------- */
function candidatesForUrl(url){
  const list = [url];
  try { list.push(encodeURI(url)); } catch {}
  const m = url.match(/\.(jpg|jpeg|png|webp)$/i);
  if (m) {
    const extBase = url.slice(0, -m[0].length);
    const exts = ["jpg","JPG","jpeg","JPEG","webp","png","PNG"];
    exts.forEach(ex => list.push(`${extBase}.${ex}`));
  }
  return [...new Set(list)];
}
function loadImageWithFallbacks(imgEl, urls, onSuccess, onFail){
  let i = 0;
  function tryNext(){
    if (i >= urls.length) { onFail && onFail(); return; }
    const u = urls[i++];
    imgEl.onerror = () => { tryNext(); };
    imgEl.onload  = () => { onSuccess && onSuccess(u); };
    imgEl.src = u;
  }
  tryNext();
}
function showImageForCurrentItem(){
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  let i = imgIndexMap[item.commonName] ?? 0;
  if (i < 0) i = 0;
  if (i > arr.length - 1) i = arr.length - 1;
  imgIndexMap[item.commonName] = i;

  const wanted = arr[i] || "";
  const cands = candidatesForUrl(wanted);

  loadImageWithFallbacks(
    imgEl,
    cands,
    () => {
      imgEl.alt = `Foto ${i+1} av ${arr.length} – ${item.commonName} (${item.latinName})`;
      imgCounter.textContent = `${i+1}/${arr.length}`;
      const single = arr.length <= 1;
      imgPrevBtn.disabled = single || i === 0;
      imgNextBtn.disabled = single || i === arr.length - 1;
      imgPrevBtn.style.display = single ? "none":"flex";
      imgNextBtn.style.display = single ? "none":"flex";
      imgCounter.style.display = single ? "none":"block";
    },
    () => {
      imgEl.removeAttribute('src');
      imgEl.alt = `Kunde inte ladda bild: ${wanted}`;
      imgCounter.textContent = `0/${arr.length}`;
      imgPrevBtn.disabled = true;
      imgNextBtn.disabled = true;
      imgPrevBtn.style.display = "none";
      imgNextBtn.style.display = "none";
      imgCounter.style.display = "none";
    }
  );
}

function render(){
  const item = QUIZ[idx];
  qNum.textContent = (idx+1).toString();
  scoreEl.textContent = score.toString();
  answerMsg.innerHTML = "";
  mcMsg.innerHTML = "";
  if (imgIndexMap[item.commonName] == null) imgIndexMap[item.commonName] = 0;

  // Bild
  showImageForCurrentItem();

  // MC – bygg rullmeny
  if (mode==="mc"){
    buildMCSelect(item);
  }
}

/* ---------- Flervalsläge: rullmeny med 4 alternativ ---------- */
function buildMCSelect(item){
  mcSelect.innerHTML = `<option value="">-- Välj --</option>`;
  // Försök ta 3 distraktorer från BANK i samma grupp
  let pool = QUIZ.filter(x => x.commonName!==item.commonName && x.group===item.group).map(x=>x.commonName);

  // Om för få i BANK, fyll på från DISTRACTOR_POOL (utan dubbletter)
  if (pool.length < 3) {
    const extra = DISTRACTOR_POOL.filter(nm => nm !== item.commonName && !pool.includes(nm));
    pool = pool.concat(sample(extra, Math.max(0, 3 - pool.length)));
  }
  const distractors = sample(pool, 3).map(nm => ({commonName:nm}));

  const options = sample([item, ...distractors], 4);
  options.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.commonName;
    o.textContent = opt.commonName;
    mcSelect.appendChild(o);
  });
}

/* ---------- Händelser ---------- */
document.querySelectorAll('input[name="mode"]').forEach(r => {
  r.addEventListener("change", e => {
    mode = e.target.value;
    modeLabel.textContent = mode==="text"?"Fritext":"Flervalsfråga";
    textBox.style.display = mode==="text" ? "block" : "none";
    mcBox.style.display   = mode==="mc"   ? "block" : "none";
    render();
  });
});

checkBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  if(mode==="text"){
    const val = answerInput.value.trim();
    if(!val){ answerMsg.innerHTML = `<span class="muted">Skriv ett namn först.</span>`; return; }
    const ok = isExactMatchWithSpaces(val, item);
    if(ok){ answerMsg.innerHTML = `<span class="correct">Rätt!</span> ${item.commonName} (${item.latinName})`; score++; scoreEl.textContent = score.toString(); }
    else  { answerMsg.innerHTML = `<span class="wrong">Inte riktigt.</span> Försök igen eller klicka “Visa rätt svar”.`; }
  }else{
    const chosen = mcSelect.value;
    if(!chosen){ mcMsg.innerHTML = `<span class="muted">Välj ett alternativ i listan.</span>`; return; }
    if(chosen===item.commonName){
      mcMsg.innerHTML = `<span class="correct">Rätt!</span> ${item.commonName} (${item.latinName})`;
      score++; scoreEl.textContent = score.toString();
    }else{
      mcMsg.innerHTML = `<span class="wrong">Fel.</span> Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})`;
    }
  }
});

showBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const also = (item.aliases && item.aliases.length) ? ` | alias: ${item.aliases.slice(0,3).join(", ")}${item.aliases.length>3?"…":""}` : "";
  if(mode==="text"){ answerMsg.innerHTML = `Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})${also}`; }
  else{ mcMsg.innerHTML = `Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})${also}`; }
});

prevBtn.addEventListener("click", () => { idx = (idx-1+QUIZ.length)%QUIZ.length; answerInput.value = ""; render(); });
nextBtn.addEventListener("click", () => { idx = (idx+1)%QUIZ.length; answerInput.value = ""; render(); });

imgPrevBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const i = (imgIndexMap[item.commonName] ?? 0) - 1;
  imgIndexMap[item.commonName] = Math.max(0, i);
  showImageForCurrentItem();
});
imgNextBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  const i = (imgIndexMap[item.commonName] ?? 0) + 1;
  imgIndexMap[item.commonName] = Math.min(arr.length - 1, i);
  showImageForCurrentItem();
});
imgEl.addEventListener("click", () => {
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  if (arr.length <= 1) return;
  const i = (imgIndexMap[item.commonName] ?? 0) + 1;
  imgIndexMap[item.commonName] = (i > arr.length - 1) ? 0 : i;
  showImageForCurrentItem();
});

// Liten felruta vid JS-fel (hjälper om något skulle sluta funka)
window.addEventListener('error', e => {
  const box = document.createElement('div');
  box.style.cssText = 'position:fixed;left:10px;bottom:10px;max-width:90%;background:#fff1f2;color:#b91c1c;border:1px solid #fecaca;padding:.6rem .8rem;border-radius:.5rem;font:12px/1.4 system-ui;z-index:99999';
  box.textContent = 'Fel i skript: ' + (e.message || e.error || 'okänt');
  document.body.appendChild(box);
  console.error('Algquiz fel:', e);
});

// Init
render();
</script>
</body>
</html>
