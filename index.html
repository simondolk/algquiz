<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Algquiz – Södra Sverige (30 arter)</title>
  <style>
    :root{
      --brand:#0b6ea8; --accent:#0aa770; --bg:#f6f8fb; --text:#1f2937; --muted:#6b7280; --danger:#c0392b;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);}
    header{padding:1rem 1.25rem;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:5}
    h1{font-size:1.4rem;margin:.2rem 0}
    .wrap{max-width:1100px;margin:0 auto;padding:1.25rem}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:1rem}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.03);overflow:hidden}
    .imgBox{aspect-ratio:4/3;background:#eef2f7;display:flex;align-items:center;justify-content:center;position:relative}
    .imgBox img{max-width:100%;max-height:100%;object-fit:contain}
    .controls{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-top:1px solid #e5e7eb}
    button{cursor:pointer;border:none;border-radius:.5rem;background:var(--brand);color:#fff;padding:.6rem .9rem;font-weight:600}
    button.secondary{background:#eef2f7;color:#111;border:1px solid #e5e7eb}
    button.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
    button.link{background:transparent;color:var(--brand);border:none;padding:.25rem .4rem}
    .danger{background:var(--danger)}
    .ok{background:var(--accent)}
    .muted{color:var(--muted)}
    .panel{padding:1rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .row > *{margin:.15rem 0}
    input[type="text"]{width:100%;padding:.7rem .8rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem}
    select{padding:.6rem .8rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem;background:#fff}
    .badge{display:inline-flex;align-items:center;gap:.4rem;background:#eef2f7;border:1px solid #e5e7eb;color:#374151;padding:.2rem .5rem;border-radius:.4rem;font-size:.85rem}
    .score{font-weight:700}
    .sliderBox{display:flex;align-items:center;gap:.6rem}
    input[type="range"]{width:150px}
    .answer{margin-top:.5rem}
    .answer .correct{color:var(--accent);font-weight:700}
    .answer .wrong{color:var(--danger);font-weight:700}
    footer{padding:1rem 1.25rem;color:#6b7280}
    details{margin-top:.6rem}
    .mc-options{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin:.5rem 0}
    .mc-options button{background:#fff;color:#111;border:1px solid #e5e7eb;text-align:left}
    .mc-options button.correct{border-color:var(--accent)}
    .mc-options button.incorrect{border-color:var(--danger)}
    .pill{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .65rem}
    /* Bildsnurra */
    .imgNav{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(255,255,255,.88); color:#111; border:1px solid #e5e7eb;
      width:36px; height:36px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-weight:700;
    }
    .imgNav.prev{left:.5rem}
    .imgNav.next{right:.5rem}
    .imgNav:disabled{opacity:.4; cursor:not-allowed}
    .imgCounter{
      position:absolute; right:.6rem; bottom:.5rem;
      background:rgba(0,0,0,.65); color:#fff; font-size:.85rem;
      padding:.2rem .45rem; border-radius:.4rem;
    }
  </style>
</head>
<body>

<header class="wrap">
  <h1>Algquiz</h1>
  <div class="row">
    <span class="badge">Fråga: <span id="qNum">1</span> / <span id="qTotal">30</span></span>
    <span class="badge">Poäng: <span class="score" id="score">0</span></span>
    <span class="badge">Läge: <strong id="modeLabel">Fritext</strong></span>
    <span class="badge">Stavfels­tolerans: <span id="tolLabel">medel</span></span>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div class="imgBox" id="imgBox" aria-live="polite">
      <button id="imgPrevBtn" class="imgNav prev" aria-label="Föregående bild">◀</button>
      <img id="algImg" alt="Algfoto i quizet" src="" />
      <button id="imgNextBtn" class="imgNav next" aria-label="Nästa bild">▶</button>
      <div id="imgCounter" class="imgCounter" aria-live="polite">1/1</div>
    </div>
    <div class="controls">
      <button id="prevBtn" class="secondary" title="Föregående">←</button>
      <div class="row">
        <button id="showBtn" class="ghost">Visa rätt svar</button>
        <button id="checkBtn" class="">Kontrollera</button>
        <button id="nextBtn" class="ok">Nästa →</button>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="panel">
      <h2>Vad heter denna alg?</h2>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label class="pill"><input type="radio" name="mode" value="text" checked> Fritext</label>
          <label class="pill"><input type="radio" name="mode" value="mc"> Flervalsfråga</label>
        </div>
        <div class="sliderBox">
          <label for="tol">Tolerans</label>
          <input type="range" id="tol" min="0" max="2" step="1" value="1" />
        </div>
      </div>

      <!-- Fritext -->
      <div id="textBox">
        <input id="answerInput" type="text" placeholder="Skriv svenskt namn (latin går också bra)..." autocomplete="off" />
        <div class="answer" id="answerMsg"></div>
      </div>

      <!-- Flervalsläge -->
      <div id="mcBox" style="display:none">
        <div class="mc-options" id="mcOptions"></div>
        <div id="mcMsg" class="answer"></div>
      </div>

      <details>
        <summary>Tips</summary>
        <ul>
          <li>Stavfel tolereras. Även latinska namn och vanliga synonymer godkänns.</li>
          <li>Å/Ä/Ö jämställs med A/A/O, mellanslag och bindestreck ignoreras.</li>
          <li>“Visa rätt svar” avslöjar det korrekta namnet för den aktuella bilden.</li>
        </ul>
      </details>
    </div>
  </aside>
</main>

<footer class="wrap">
  <small class="muted">Byggd för undervisning: södra Sveriges vanliga makroalger (Kattegatt/Öresund). Lägg bilder i <code>/images</code> och ange filnamn under respektive art i listan i koden.</small>
</footer>

<script>
/*** =======================
 *  KONFIGURATION BILDER
 *  ======================= */
const BASE_IMAGE_URL = "https://simondolk.github.io/algquiz/images/";

/*** =======================
 *  HJÄLPLIGA FUNKTIONER
 *  ======================= */
const norm = (s) => {
  if (!s) return "";
  return s.toLowerCase()
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/å/g,"a").replace(/ä/g,"a").replace(/ö/g,"o")
    .replace(/[^a-z0-9]/g,"");
};
function lev(a,b){
  const m=a.length, n=b.length;
  if(m===0) return n; if(n===0) return m;
  const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
function isMatch(userInput, item, tolLevel){
  const cand = norm(userInput);
  const accepted = [item.commonName, item.latinName, ...(item.aliases||[])].map(norm);
  if (accepted.includes(cand)) return true;
  const maxLen = Math.max(1, ...accepted.map(s=>s.length));
  const base = tolLevel===0 ? 0.12 : (tolLevel===1 ? 0.20 : 0.28);
  const maxDist = Math.ceil(base * maxLen);
  return accepted.some(acc => lev(cand, acc) <= maxDist || acc.includes(cand) || cand.includes(acc));
}
const sample = (arr, n) => {
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a.slice(0,n);
};

/*** =======================
 *  ARTLISTA (exempel)
 *  ======================= */
// Börja med en art som test: Blåstång med 1–3 bilder.
// Lägg till fler arter efterhand.
const BANK = [
  { commonName:"Blåstång", latinName:"Fucus vesiculosus", group:"Brunalger",
    aliases:["blastang","bladder wrack","blue tang"],
    images:["blastang_1.jpg","blastang_2.jpg","blastang_3.jpg"] // byt/behåll så det matchar /images/
  },

  // När du vill: lägg in fler arter här:
  // { commonName:"Havssallat", latinName:"Ulva lactuca", group:"Grönalger", images:["havssallat_1.jpg"] },
  // ...
];

// Bygg QUIZ med fullständiga bild-URL:er
let QUIZ = BANK.map(item => ({
  ...item,
  images: (item.images||[]).map(file => BASE_IMAGE_URL + file)
}));

/*** =======================
 *  TILLSTÅND / UI
 *  ======================= */
let idx = 0;
let score = 0;
let mode = "text";    // "text" eller "mc"
let tolLevel = 1;     // 0=låg,1=medel,2=hög

// Bildsnurra: vilket foto per art visas just nu
let imgIndexMap = {};

const qNum = document.getElementById("qNum");
const qTotal = document.getElementById("qTotal");
const scoreEl = document.getElementById("score");
const imgEl = document.getElementById("algImg");
const imgPrevBtn = document.getElementById("imgPrevBtn");
const imgNextBtn = document.getElementById("imgNextBtn");
const imgCounter = document.getElementById("imgCounter");
const answerInput = document.getElementById("answerInput");
const answerMsg = document.getElementById("answerMsg");
const showBtn = document.getElementById("showBtn");
const checkBtn = document.getElementById("checkBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const modeLabel = document.getElementById("modeLabel");
const tol = document.getElementById("tol");
const tolLabel = document.getElementById("tolLabel");
const mcBox = document.getElementById("mcBox");
const textBox = document.getElementById("textBox");
const mcOptionsEl = document.getElementById("mcOptions");
const mcMsg = document.getElementById("mcMsg");
qTotal.textContent = QUIZ.length.toString();

function setTolLabel(){
  tolLabel.textContent = tolLevel===0?"låg":(tolLevel===1?"medel":"hög");
}
setTolLabel();

function buildMC(item){
  mcOptionsEl.innerHTML = "";
  const distractors = sample(QUIZ.filter(x => x.commonName!==item.commonName && x.group===item.group), 3);
  const options = sample([item, ...distractors], 4);

  options.forEach(opt => {
    const b = document.createElement("button");
    b.textContent = opt.commonName;
    b.onclick = () => {
      [...mcOptionsEl.children].forEach(c => c.disabled = true);
      if(opt.commonName===item.commonName){
        b.classList.add("correct");
        mcMsg.innerHTML = `<span class="correct">Rätt!</span> ${item.commonName} (${item.latinName})`;
        score++; scoreEl.textContent = score.toString();
      }else{
        b.classList.add("incorrect");
        mcMsg.innerHTML = `<span class="wrong">Fel.</span> Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})`;
      }
    };
    mcOptionsEl.appendChild(b);
  });
}

/* ---------- Robust bildladdning: fallback-varianter ---------- */
function candidatesForUrl(url){
  const list = [url];
  try { list.push(encodeURI(url)); } catch {}
  const m = url.match(/\.(jpg|jpeg|png|webp)$/i);
  if (m) {
    const extBase = url.slice(0, -m[0].length);
    const exts = ["jpg","JPG","jpeg","JPEG","webp","png","PNG"];
    exts.forEach(ex => list.push(`${extBase}.${ex}`));
  }
  return [...new Set(list)];
}
function loadImageWithFallbacks(imgEl, urls, onSuccess, onFail){
  let i = 0;
  function tryNext(){
    if (i >= urls.length) { onFail && onFail(); return; }
    const u = urls[i++];
    imgEl.onerror = () => { tryNext(); };
    imgEl.onload  = () => { onSuccess && onSuccess(u); };
    imgEl.src = u;
  }
  tryNext();
}

function showImageForCurrentItem(){
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  let i = imgIndexMap[item.commonName] ?? 0;
  if (i < 0) i = 0;
  if (i > arr.length - 1) i = arr.length - 1;
  imgIndexMap[item.commonName] = i;

  const wanted = arr[i] || "";
  const cands = candidatesForUrl(wanted);

  loadImageWithFallbacks(
    imgEl,
    cands,
    (usedUrl) => {
      imgEl.alt = `Foto ${i+1} av ${arr.length} – ${item.commonName} (${item.latinName})`;
      imgCounter.textContent = `${i+1}/${arr.length}`;
      const single = arr.length <= 1;
      imgPrevBtn.disabled = single || i === 0;
      imgNextBtn.disabled = single || i === arr.length - 1;
      imgPrevBtn.style.display = single ? "none":"flex";
      imgNextBtn.style.display = single ? "none":"flex";
      imgCounter.style.display = single ? "none":"block";
    },
    () => {
      imgEl.removeAttribute('src');
      imgEl.alt = `Kunde inte ladda bild: ${wanted}`;
      imgCounter.textContent = `0/${arr.length}`;
      imgPrevBtn.disabled = true;
      imgNextBtn.disabled = true;
      imgPrevBtn.style.display = "none";
      imgNextBtn.style.display = "none";
      imgCounter.style.display = "none";
      console.warn("Kunde inte ladda någon kandidat:", cands);
    }
  );
}

function render(){
  const item = QUIZ[idx];
  qNum.textContent = (idx+1).toString();
  scoreEl.textContent = score.toString();
  answerMsg.innerHTML = "";
  mcMsg.innerHTML = "";
  if (imgIndexMap[item.commonName] == null) imgIndexMap[item.commonName] = 0;
  showImageForCurrentItem();
  if(mode==="mc"){ buildMC(item); }
}

/* ————— Händelser ————— */
document.querySelectorAll('input[name="mode"]').forEach(r => {
  r.addEventListener("change", e => {
    mode = e.target.value;
    modeLabel.textContent = mode==="text"?"Fritext":"Flervalsfråga";
    textBox.style.display = mode==="text" ? "block" : "none";
    mcBox.style.display = mode==="mc" ? "block" : "none";
    render();
  });
});
tol.addEventListener("input", e => { tolLevel = parseInt(e.target.value,10); setTolLabel(); });

checkBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  if(mode==="text"){
    const val = answerInput.value.trim();
    if(!val){ answerMsg.innerHTML = `<span class="muted">Skriv ett namn först.</span>`; return; }
    const ok = isMatch(val, item, tolLevel);
    if(ok){ answerMsg.innerHTML = `<span class="correct">Rätt!</span> ${item.commonName} (${item.latinName})`; score++; scoreEl.textContent = score.toString(); }
    else{ answerMsg.innerHTML = `<span class="wrong">Inte riktigt.</span> Försök igen eller klicka “Visa rätt svar”.`; }
  }else{
    mcMsg.innerHTML = `<span class="muted">Välj ett alternativ ovan.</span>`;
  }
});
showBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const also = (item.aliases && item.aliases.length) ? ` | alias: ${item.aliases.slice(0,3).join(", ")}${item.aliases.length>3?"…":""}` : "";
  if(mode==="text"){ answerMsg.innerHTML = `Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})${also}`; }
  else{ mcMsg.innerHTML = `Rätt svar: <strong>${item.commonName}</strong> (${item.latinName})${also}`; }
});
prevBtn.addEventListener("click", () => { idx = (idx-1+QUIZ.length)%QUIZ.length; answerInput.value = ""; render(); });
nextBtn.addEventListener("click", () => { idx = (idx+1)%QUIZ.length; answerInput.value = ""; render(); });

imgPrevBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const i = (imgIndexMap[item.commonName] ?? 0) - 1;
  imgIndexMap[item.commonName] = Math.max(0, i);
  showImageForCurrentItem();
});
imgNextBtn.addEventListener("click", () => {
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  const i = (imgIndexMap[item.commonName] ?? 0) + 1;
  imgIndexMap[item.commonName] = Math.min(arr.length - 1, i);
  showImageForCurrentItem();
});
imgEl.addEventListener("click", () => {
  const item = QUIZ[idx];
  const arr = (item.images && item.images.length) ? item.images : [""];
  if (arr.length <= 1) return;
  const i = (imgIndexMap[item.commonName] ?? 0) + 1;
  imgIndexMap[item.commonName] = (i > arr.length - 1) ? 0 : i;
  showImageForCurrentItem();
});

// Visa fel i en liten ruta om något skriptfel inträffar
window.addEventListener('error', e => {
  const box = document.createElement('div');
  box.style.cssText = 'position:fixed;left:10px;bottom:10px;max-width:90%;background:#fff1f2;color:#b91c1c;border:1px solid #fecaca;padding:.6rem .8rem;border-radius:.5rem;font:12px/1.4 system-ui;z-index:99999';
  box.textContent = 'Fel i skript: ' + (e.message || e.error || 'okänt');
  document.body.appendChild(box);
  console.error('Algquiz fel:', e);
});

// Init
render();
</script>
</body>
</html>
