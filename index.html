<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Quiz – Flera kategorier</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --danger:#ef4444; --btn:#1f2937; --btn-text:#e5e7eb;
      /* Bildram A: fast, responsiv höjd (justera vid behov) */
      --frame-h: clamp(240px, 60vh, 520px);
    }
    *{box-sizing:border-box}
    html { -webkit-text-size-adjust: 100%; }
    * { -webkit-tap-highlight-color: transparent; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      padding:16px 20px; border-bottom:1px solid #1f2937;
      display:flex; gap:16px; flex-wrap:wrap; align-items:center
    }
    header h1{font-size:20px;margin:0}
    main{max-width:980px;margin:0 auto;padding:20px}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;color:var(--muted)}
    select, input[type="text"], button{
      background:var(--btn); color:var(--btn-text);
      border:1px solid #374151; border-radius:8px; padding:8px 10px
    }
    label{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;overflow:hidden}

    /* === Bildram A (fast höjd) === */
    .card .media{
      position:relative; display:grid; place-items:center;
      background:#0b1220; height:var(--frame-h);
    }
    /* Bildläge C (contain/cover) styrs via --fit på body */
    .card img{
      width:100%; height:100%;
      object-fit: var(--fit, contain); /* default "Hela bilden" */
      max-width:none; max-height:none;
    }
    body.cover{ --fit: cover; } /* "Fyll" */

    .nav{
      position:absolute; top:50%; transform:translateY(-50%);
      border:none; background:rgba(15,23,42,.6); color:#e5e7eb;
      width:40px; height:48px; border-radius:8px; display:grid; place-items:center; cursor:pointer
    }
    .nav:hover{background:rgba(15,23,42,.8)}
    .nav.prev{left:8px}
    .nav.next{right:8px}
    .counter{
      position:absolute; bottom:8px; right:10px;
      background:rgba(2,6,23,.6); padding:2px 8px; border-radius:999px;
      font-size:12px; color:#cbd5e1
    }
    .card .content{padding:16px;display:grid;gap:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .stats{color:var(--muted)}
    .choices{display:grid;gap:8px}
    .choice{display:flex;gap:8px;align-items:center}
    .help{color:var(--muted);font-size:14px}
    .badge{
      display:inline-block;padding:2px 8px;border-radius:999px;background:#1e293b;
      color:#cbd5e1;font-size:12px;cursor:default; user-select:none
    }
    .ok{color:var(--accent)}
    .bad{color:var(--danger)}
    footer{padding:20px;color:#94a3b8;text-align:center}

    /* Touch-vänligt (iPhone-alternativ 1) */
    .nav, button, .badge, label { touch-action: manipulation; }

    @media (hover:none) and (pointer:coarse){
      .nav{ width:56px; height:56px; }      /* större pilar */
      button, .badge{ min-height:44px; }    /* större interaktionsytor */
      input, select{ font-size:16px; }      /* undvik auto-zoom på inputs */
    }
    @media (max-width:480px){ .nav{width:52px;height:52px} .nav.prev{left:12px} .nav.next{right:12px} }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Quiz</h1>
    <div class="toolbar">
      <label for="categorySelect">Kategori</label>
      <select id="categorySelect"></select>

      <!-- Läges-badge (free/mc) med knappsemantik -->
      <span class="badge" id="modeBadge" title="Klicka för att växla" role="button" tabindex="0" aria-pressed="true">
        Läge: Fritext
      </span>

      <!-- NY: Bildläge-toggle (A+C) -->
      <span class="badge" id="fitBadge" title="Växla bildläge" role="button" tabindex="0" aria-pressed="false">
        Bildläge: Hela bilden
      </span>

      <label><input type="checkbox" id="shuffleToggle"> Blanda frågor</label>
    </div>
    <div class="stats" id="stats">Fråga: – / – · Poäng: 0</div>
  </header>

  <main>
    <article class="card">
      <div class="media">
        <button class="nav prev" id="imgPrevBtn" aria-label="Föregående bild">◀</button>
        <img id="image" decoding="async" alt="Bild för aktuell fråga"/>
        <button class="nav next" id="imgNextBtn" aria-label="Nästa bild">▶</button>
        <div class="counter" id="imageCounter">1/1</div>
      </div>
      <div class="content">
        <h2 id="prompt">Vad heter denna art?</h2>
        <!-- diskret taxa-info (group/subgroup) -->
        <div class="help" id="taxaBadge"></div>

        <div class="row" id="freeRow">
          <input id="answerInput" type="text" placeholder="Skriv svaret här…" size="40"/>
          <button id="checkBtn">Kontrollera</button>
        </div>
        <div class="choices" id="mcRow" style="display:none"></div>
        <div class="row">
          <button id="revealBtn">Visa rätt svar</button>
          <button id="nextBtn">Nästa →</button>
          <span id="feedback" role="status" aria-live="polite"></span>
        </div>
        <div class="help">
          Tips: Endast skiftläge ignoreras och mellanslag accepteras (särskrivning). Inga övriga stavfel.
        </div>
      </div>
    </article>
  </main>

  <footer>© <span id="byline">Simon Dolk</span></footer>

<script>
(function(){
  const CATEGORY_KEY='quiz.category';
  const MODE_KEY='quiz.mode'; // 'free' | 'mc'
  const SHUFFLE_KEY='quiz.shuffle';
  const FIT_KEY='quiz.fit';   // 'contain' | 'cover'

  const $ = sel => document.querySelector(sel);

  const els = {
    title: $('#title'), byline: $('#byline'), cat: $('#categorySelect'),
    mode: $('#modeBadge'), fit: $('#fitBadge'), shuffle: $('#shuffleToggle'),
    stats: $('#stats'), img: $('#image'), prompt: $('#prompt'),
    freeRow: $('#freeRow'), input: $('#answerInput'),
    mcRow: $('#mcRow'),
    check: $('#checkBtn'), reveal: $('#revealBtn'), next: $('#nextBtn'),
    feedback: $('#feedback'),
    prev: $('#imgPrevBtn'), nextImg: $('#imgNextBtn'), counter: $('#imageCounter')
  };

  // ======= State =======
  let categories = [];
  let data = { title: 'Quiz', questions: [] };
  let order = [];
  let i = 0; // index i order
  let score = 0;
  let seen = new Set();
  let imgIdx = 0;

  // ======= Settings =======
  let mode = localStorage.getItem(MODE_KEY) || 'free';
  let shuffle = localStorage.getItem(SHUFFLE_KEY) === '1';
  els.shuffle.checked = shuffle;

  function setMode(m){
    mode = m; localStorage.setItem(MODE_KEY, m);
    els.mode.textContent = 'Läge: ' + (m==='free' ? 'Fritext' : 'Flervalsfråga');
    els.mode.setAttribute('aria-pressed', m==='free' ? 'true' : 'false');
    els.freeRow.style.display = (m==='free')?'flex':'none';
    els.mcRow.style.display = (m==='mc')?'grid':'none';
    els.feedback.textContent = '';
    els.feedback.className = '';
  }
  setMode(mode);

  function setFit(f){
    // f = 'contain' | 'cover'
    const isCover = (f === 'cover');
    document.body.classList.toggle('cover', isCover);
    localStorage.setItem(FIT_KEY, f);
    if (els.fit){
      els.fit.textContent = 'Bildläge: ' + (isCover ? 'Fyll' : 'Hela bilden');
      els.fit.setAttribute('aria-pressed', isCover ? 'true' : 'false');
    }
  }
  let fit = localStorage.getItem(FIT_KEY) || 'contain';
  setFit(fit);

  // === Filename variant helpers ===
  function pathParts(p){
    const m = p.match(/^(.*\/)?([^\/]+)$/); // dir, file
    const dir = (m && m[1]) || '';
    const file = (m && m[2]) || p;
    const m2 = file.match(/^(.*?)(\.[^.]+)?$/);
    const base = m2[1];
    const ext = (m2[2]||'').toLowerCase();
    return {dir, base, ext};
  }
  function extVariants(ext){
    const core = ['.jpg','.jpeg','.png','.webp','.avif'];
    const set = new Set([ext.toLowerCase(), ...core]);
    const out = [];
    set.forEach(e=>{ out.push(e); out.push(e.toUpperCase()); });
    return [...new Set(out)];
  }
  function numberStrippers(base){
    // Ta bort t.ex. "_1", "-2", "_12" eller "-04" i slutet om det finns
    const m = base.match(/^(.*?)(?:[_-]\d+)?$/);
    return m ? m[1] : base;
  }
  function buildVariants(p){
    const {dir, base, ext} = pathParts(p);
    const root = numberStrippers(base);
    const exts = extVariants(ext || '.jpg');
    const names = new Set();
    const push = s => names.add(dir + s);
    const stems = [root, root+'_1', root+'_2', root+'_3', root+'_4', root+'-1', root+'-2', root+'-3', root+'-4'];
    stems.forEach(st => exts.forEach(e => push(st+e)));
    return [...names];
  }

  // Robust normering: ignorera skiftläge + mellanslag + Unicode-normalisering
  function normalize(s){
    return (s||'')
      .normalize('NFKC')
      .toLowerCase()
      .replace(/\s+/g,'');
  }
  function isCorrect(input, answers){
    const n = normalize(input);
    return (answers||[]).some(a => normalize(a)===n);
  }
  function registerResult(ok){
    if(ok && !seen.has(order[i])){ score++; seen.add(order[i]); updateStats(); }
  }

  // ===== NEW HELPERS for new data format + subgroup-aware MC =====
  function uniq(arr){
    return [...new Set((arr || []).filter(Boolean))];
  }

  function getSubgroup(q){
    // Standardiserad fråga eller legacy
    return q.subgroup || q.group || (q.meta && (q.meta.subgroup || q.meta.group)) || '';
  }

  // Subgroup index: subgroup -> array of question objects
  let bySubgroup = new Map();
  function indexBySubgroup(){
    bySubgroup.clear();
    (data.questions || []).forEach(q => {
      const g = getSubgroup(q);
      if(!g) return;
      if(!bySubgroup.has(g)) bySubgroup.set(g, []);
      bySubgroup.get(g).push(q);
    });
  }

  // Mappa nytt array-schema till internt frågeschema
  function mapRecordToQuestion(rec){
    const answers = uniq([rec.commonName, rec.latinName, ...(rec.aliases || [])]);
    const images = (rec.images && rec.images.length) ? rec.images : (rec.image ? [rec.image] : []);
    return {
      answers,
      images,
      subgroup: rec.subgroup || rec.group || '',
      group: rec.group || '',
      commonName: rec.commonName || '',
      latinName: rec.latinName || ''
    };
  }

  function sample(arr, k){
    const a=[...arr];
    for(let j=a.length-1;j>0;--j){const r=Math.floor(Math.random()*(j+1)); [a[j],a[r]]=[a[r],a[j]]}
    return a.slice(0,k);
  }

  function buildOrder(){
    order = data.questions.map((_,idx)=>idx);
    if(shuffle){ order = sample(order, order.length); }
    i = 0; score = 0; seen.clear();
  }

  function current(){ return data.questions[order[i]]; }

  function toImagesList(q){
    let candidates = [];
    if(q.images && q.images.length){ candidates = [...q.images]; }
    else if(q.image){ candidates = [q.image]; }
    // enrich med variantgissningar
    let enriched = [];
    candidates.forEach(p=>{ enriched.push(p); buildVariants(p).forEach(v=> enriched.push(v)); });
    return [...new Set(enriched)];
  }

  function normalizeQuestion(q){
    if(!q.images || q.images.length===0){ q.images = toImagesList(q); }
    return q;
  }

  function updateStats(){
    els.stats.textContent = `Fråga: ${i+1} / ${order.length} · Poäng: ${score}`;
  }

  async function validateImages(q){
    if(q._validImages) return q._validImages;
    const candidates = toImagesList(q);
    const checks = await Promise.all(
      candidates.map(url => new Promise(res => {
        const img = new Image();
        img.onload = () => res(url);
        img.onerror = () => res(null);
        img.src = url;
      }))
    );
    q._validImages = checks.filter(Boolean);
    return q._validImages;
  }

  function updateCarouselUI(n){
    els.counter.textContent = n? `${imgIdx+1}/${n}` : '';
    const show = n>1 ? 'grid' : 'none';
    els.prev.style.display = show; els.nextImg.style.display = show;
  }

  async function showImage(){
    const q = normalizeQuestion(current());
    els.img.alt = 'Laddar bild...';
    const imgs = await validateImages(q);
    const n = imgs.length;
    if(n===0){
      els.img.removeAttribute('src');
      els.img.alt = 'Ingen bild tillgänglig';
      updateCarouselUI(0);
      return;
    }
    imgIdx = (imgIdx + n) % n; // wrap
    els.img.src = imgs[imgIdx];
    els.img.alt = 'Bild: ' + ((q.answers && q.answers[0]) || 'Okänd');
    updateCarouselUI(n);
  }

  function latinFromAnswers(ans){
    if(!ans || !ans.length) return '';
    const latinRegex = /^[A-ZÅÄÖ][a-zåäöéèê\-]+\s+[a-zåäöéèê\-\.]+$/;
    const found = ans.find(a => latinRegex.test(a.trim()));
    if(found) return found;
    return ans[1] || '';
  }

  function primaryCommon(ans){
    if(!ans || !ans.length) return '';
    // Preferera första icke-latinska binomiala
    const latinRegex = /^[A-ZÅÄÖ][a-zåäöéèê\-]+\s+[a-zåäöéèê\-\.]+$/;
    const nonLatin = ans.find(a => !latinRegex.test(a.trim()));
    return nonLatin || ans[0];
  }

  function render(){
    els.title.textContent = (data.title || 'Quiz');
    updateStats();
    const q = normalizeQuestion(current());
    imgIdx = 0; // reset per fråga
    showImage();
    els.prompt.textContent = 'Vad heter denna art?';
    els.input.value = '';
    els.feedback.textContent = '';
    els.feedback.className = '';

    // taxa-badge (diskret)
    const badge = document.getElementById('taxaBadge');
    if (badge) {
      const grp = q.group ? q.group : '';
      const sub = q.subgroup ? ` · ${q.subgroup}` : '';
      badge.textContent = (grp || sub) ? `Kategori: ${grp}${sub}` : '';
    }

    // Flervals-läge
    if(mode==='mc'){
      const correct = (q.answers && primaryCommon(q.answers)) || '';
      const g = getSubgroup(q);

      const sameGroupQs = (bySubgroup.get(g) || []).filter(x => x !== q);
      let poolSame = uniq(
        sameGroupQs
          .map(x => (x.answers && primaryCommon(x.answers)) || '')
          .filter(x => x && x !== correct)
      );

      const allOther = data.questions.filter(x => x !== q && getSubgroup(x) !== g);
      let poolOther = uniq(
        allOther
          .map(x => (x.answers && primaryCommon(x.answers)) || '')
          .filter(x => x && x !== correct)
      );

      const need = 3;
      let distractors = sample(poolSame, Math.min(need, poolSame.length));

      if (distractors.length < need) {
        const remaining = need - distractors.length;
        distractors = distractors.concat(sample(poolOther, Math.min(remaining, poolOther.length)));
      }

      if (distractors.length < need) {
        const allPrimary = uniq(
          data.questions
            .filter(x => x !== q)
            .map(x => (x.answers && primaryCommon(x.answers)) || '')
            .filter(Boolean)
        ).filter(x => x !== correct && !distractors.includes(x));
        distractors = distractors.concat(sample(allPrimary, Math.max(0, need - distractors.length)));
      }

      let options = uniq([correct, ...distractors]);
      options = sample(options, options.length); // blanda

      els.mcRow.innerHTML = '';
      options.forEach(opt =>{
        const id = 'opt_'+Math.random().toString(36).slice(2,8);
        const div = document.createElement('div'); div.className='choice';
        div.innerHTML = `<input type="radio" name="mc" id="${id}" value="${opt}"><label for="${id}">${opt}</label>`;
        els.mcRow.appendChild(div);
      });
    }
  }

  function setFeedback(ok, q){
    if(ok){
      const latin = latinFromAnswers(q.answers);
      els.feedback.textContent = latin ? `Rätt – ${latin}` : 'Rätt!';
      els.feedback.className = 'ok';
    } else {
      els.feedback.textContent = 'Fel';
      els.feedback.className = 'bad';
    }
  }

  function handleCheck(){
    const q = current();
    let ok=false;
    if(mode==='free'){
      ok = isCorrect(els.input.value, q.answers);
    } else {
      const sel = document.querySelector('input[name="mc"]:checked');
      ok = !!sel && isCorrect(sel.value, q.answers);
    }
    setFeedback(ok, q);
    registerResult(ok);
  }

  function handleMCSelection(e){
    if(e.target && e.target.name==='mc'){
      const q = current();
      const ok = isCorrect(e.target.value, q.answers);
      setFeedback(ok, q);
      registerResult(ok);
    }
  }

  function handleReveal(){
    const q = current();
    const common = primaryCommon(q.answers);
    const latin = latinFromAnswers(q.answers);
    els.feedback.textContent = latin ? `Rätt svar: ${common} — ${latin}` : `Rätt svar: ${common}`;
    els.feedback.className = '';
  }

  function handleNext(){
    if(order.length===0) return;
    i = (i+1) % order.length; render();
  }

  // ======= Eventbindningar =======
  els.check.addEventListener('click', handleCheck);
  els.reveal.addEventListener('click', handleReveal);
  els.next.addEventListener('click', handleNext);
  els.mcRow.addEventListener('change', handleMCSelection);

  // Bildkarusell
  els.prev.addEventListener('click', ()=>{ imgIdx--; showImage(); });
  els.nextImg.addEventListener('click', ()=>{ imgIdx++; showImage(); });
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft'){ imgIdx--; showImage(); }
    if(ev.key==='ArrowRight'){ imgIdx++; showImage(); }
  });

  // Läges-toggle (free/mc) → hård reload för enkel init
  els.mode.addEventListener('click', ()=>{
    const m = (mode==='free'?'mc':'free');
    localStorage.setItem(MODE_KEY, m);
    location.reload();
  });
  els.mode.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      els.mode.click();
    }
  });

  // Bildläge (contain/cover) toggle
  if (els.fit){
    els.fit.addEventListener('click', ()=>{
      fit = (fit === 'contain' ? 'cover' : 'contain');
      setFit(fit);
    });
    els.fit.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        els.fit.click();
      }
    });
  }
  // Genvägstangent 'b'
  document.addEventListener('keydown', (e)=>{
    if(e.key && e.key.toLowerCase() === 'b'){
      fit = (fit === 'contain' ? 'cover' : 'contain');
      setFit(fit);
    }
  });

  // Shuffle: mjuk uppdatering
  els.shuffle.addEventListener('change', (e)=>{
    shuffle = e.target.checked; localStorage.setItem(SHUFFLE_KEY, shuffle?'1':'0');
    buildOrder(); render();
  });

  // Förhindra double-tap-zoom på knappar (iPhone-alternativ 1)
  function preventDoubleTapZoom(el){
    let lastTouch = 0;
    el.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if(now - lastTouch < 300){
        e.preventDefault();
      }
      lastTouch = now;
    }, { passive:false });
  }
  [els.prev, els.nextImg, els.next, els.check, els.reveal]
    .filter(Boolean)
    .forEach(preventDoubleTapZoom);

  // Kategorier
  async function loadCategories(){
    const cats = await fetch('data/categories.json').then(r=>r.json());
    categories = cats;
    els.cat.innerHTML = '';
    cats.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.name; els.cat.appendChild(opt);
    });
    const saved = localStorage.getItem(CATEGORY_KEY);
    if(saved && cats.some(c=>c.id===saved)) els.cat.value = saved;
    await loadCategory(els.cat.value || cats[0].id);
    // Byta kategori → spara + hård reload (enklare re-init)
    els.cat.addEventListener('change', e=>{
      const id = e.target.value; localStorage.setItem(CATEGORY_KEY, id); location.reload();
    });
  }

  async function loadCategory(id){
    const meta = categories.find(c=>c.id===id) || categories[0];
    localStorage.setItem(CATEGORY_KEY, meta.id);

    const raw = await fetch(meta.data).then(r=>r.json());

    if (Array.isArray(raw)) {
      // Nytt schema
      data = { title: meta.name || 'Quiz', questions: raw.map(mapRecordToQuestion) };
    } else if (raw && Array.isArray(raw.questions)) {
      // Legacy
      data = raw;
    } else {
      throw new Error('Okänt dataformat i ' + meta.data);
    }

    indexBySubgroup();
    buildOrder();
    render();
  }

  loadCategories().catch(err=>{
    console.error(err);
    els.prompt.textContent = 'Kunde inte ladda kategorierna. Kontrollera filvägarna.';
  });

})();
</script>
</body>
</html>
