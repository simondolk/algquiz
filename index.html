<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Quiz – Flera kategorier</title>
<style>
  /* ===== Miljöverkstaden-inspirerad ljus design =====
     - Ljus bakgrund, stark läsbarhet
     - Grön accent, rundade komponenter, luft och tydliga kort
     - Endast CSS: din befintliga HTML/JS fortsätter fungera
  */

  :root{
    --bg:#ffffff;
    --surface:#f8fafc;      /* ljus yta för sektioner */
    --card:#ffffff;
    --text:#1f2937;         /* slate-800 */
    --muted:#6b7280;        /* slate-500/600 */
    --border:#e5e7eb;       /* light grey */
    --shadow: 0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06);

    --primary:#22c55e;      /* grön accent */
    --primary-600:#16a34a;
    --primary-50:#ecfdf5;

    --btn:#ffffff;
    --btn-text:#111827;

    --radius:12px;
    --radius-sm:8px;
    --space:16px;
  }

  *{ box-sizing:border-box }
  html { -webkit-text-size-adjust: 100%; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    background: var(--surface);
    color: var(--text);
    line-height:1.45;
  }

  /* ===== Header ===== */
  header{
    position: sticky; top:0; z-index:10;
    padding: 14px 20px;
    border-bottom:1px solid var(--border);
    background: rgba(255,255,255,.9);
    backdrop-filter: saturate(180%) blur(8px);
    display:flex; gap:16px; flex-wrap:wrap; align-items:center
  }
  header h1{
    font-size: clamp(18px, 2.2vw, 22px);
    margin:0;
    letter-spacing:.2px;
  }
  .toolbar{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    color:var(--muted);
  }

  /* ===== Form controls / Buttons ===== */
  select, input[type="text"], button{
    background: var(--btn);
    color: var(--btn-text);
    border:1px solid var(--border);
    border-radius: var(--radius-sm);
    padding:8px 10px;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  select:focus, input[type="text"]:focus, button:focus{
    outline: none;
    border-color: var(--primary-600);
    box-shadow: 0 0 0 3px rgba(34,197,94,.25);
  }
  button{
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  button:hover{ background: var(--primary-600); border-color: var(--primary-600); }

  label{ color:var(--muted); font-size:14px }

  /* ===== Badge-knappar (t.ex. lägesväxlarna) ===== */
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px;
    border-radius: 999px;
    background: #fff;
    color:#0b1a13;
    border:1px solid var(--border);
    cursor: pointer;
    user-select: none;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }
  .badge:hover{ border-color:#d1d5db; }
  .badge[aria-pressed="true"]{
    background: var(--primary-50);
    border-color: var(--primary);
    color: #065f46;
  }

  /* ===== Stat / Footer ===== */
  .stats{ color:#475569; } /* slate-600 */
  footer{ padding:20px; color:#64748b; text-align:center }

  /* ===== Kort och media ===== */
  main{ max-width: 980px; margin: 0 auto; padding: 20px; }
  .card{
    background: var(--card);
    border:1px solid var(--border);
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
  }

  .card .media{
    position:relative; display:grid; place-items:center;
    background: #eef2f7; /* mycket ljus gråblå bakgrund för bilder */
    aspect-ratio: 16/9;  /* behåll din tidigare responsiva yta */
  }
  .card img{
    max-width:100%;
    max-height:70vh;
    object-fit: contain;
  }
  .nav{
    position:absolute; top:50%; transform:translateY(-50%);
    border:none;
    background:#ffffff;
    color:#111827;
    width:42px; height:48px;
    border-radius: 10px;
    display:grid; place-items:center;
    cursor:pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
    border:1px solid var(--border);
  }
  .nav:hover{ background:#f9fafb }
  .nav.prev{ left:10px }
  .nav.next{ right:10px }
  .counter{
    position:absolute; bottom:10px; right:12px;
    background: rgba(255,255,255,.95);
    padding:3px 10px; border-radius: 999px;
    font-size:12px; color:#334155; border:1px solid var(--border);
  }

  .card .content{ padding:16px; display:grid; gap:12px }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }

  /* ===== Flervals-alternativ som kort ===== */
  .choices{ display:grid; gap:10px }
  .choice{ display:flex; gap:8px; align-items:center }
  .choice input[type="radio"]{
    /* vi behåller radion men gör den liten och icke-distraherande */
    width:18px; height:18px; accent-color: var(--primary);
  }
  /* Alternativ: gör bara labeln till "kort" */
  .choice label{
    display:block;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius: var(--radius-sm);
    background:#fff;
    color:#0f172a;
    width:100%;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    cursor:pointer;
  }
  .choice input[type="radio"]:checked + label{
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(34,197,94,.20);
    background: #f6fff9;
  }
  .choice label:hover{ background:#f9fafb }

  /* ===== Hjälptext & feedback ===== */
  .help{ color:#64748b; font-size:14px }
  .ok{ color: var(--primary-600); font-weight:600 }
  .bad{ color:#dc2626; font-weight:600 }

  /* ===== Tillgänglighet / fokus ===== */
  :focus-visible{
    outline: 3px solid rgba(34,197,94,.45);
    outline-offset: 2px;
  }

  /* ===== Småskärmar ===== */
  @media (max-width:480px){
    .nav{ width:40px; height:44px }
  }
</style>
</head>
<body>
  <header>
    <h1 id="title">Quiz</h1>
    <div class="toolbar">
      <label for="categorySelect">Kategori</label>
      <select id="categorySelect"></select>
      <!-- Behåll visuell badge, men ge den knappsemantik -->
      <span class="badge" id="modeBadge" title="Klicka för att växla" role="button" tabindex="0" aria-pressed="true">Läge: Fritext</span>
      <label><input type="checkbox" id="shuffleToggle"> Blanda frågor</label>
    </div>
    <div class="stats" id="stats">Fråga: – / – · Poäng: 0</div>
  </header>

  <main>
    <article class="card">
      <div class="media">
        <button class="nav prev" id="imgPrevBtn" aria-label="Föregående bild">◀</button>
        <img id="image" decoding="async" alt="Bild för aktuell fråga"/>
        <button class="nav next" id="imgNextBtn" aria-label="Nästa bild">▶</button>
        <div class="counter" id="imageCounter">1/1</div>
      </div>
      <div class="content">
        <h2 id="prompt">Vad heter denna art?</h2>
        <!-- diskret taxa-info (group/subgroup) -->
        <div class="help" id="taxaBadge"></div>

        <div class="row" id="freeRow">
          <input id="answerInput" type="text" placeholder="Skriv svaret här…" size="40"/>
          <button id="checkBtn">Kontrollera</button>
        </div>
        <div class="choices" id="mcRow" style="display:none"></div>
        <div class="row">
          <button id="revealBtn">Visa rätt svar</button>
          <button id="nextBtn">Nästa →</button>
          <span id="feedback" role="status" aria-live="polite"></span>
        </div>
        <div class="help">
          Tips: Endast skiftläge ignoreras och mellanslag accepteras (särskrivning). Inga övriga stavfel.
        </div>
      </div>
    </article>
  </main>

  <footer>© <span id="byline">Simon Dolk</span></footer>

<script>
(function(){
  // ==============================
  // Konstanter, helpers och element
  // ==============================
  const CATEGORY_KEY='quiz.category';
  const MODE_KEY='quiz.mode';      // 'free' | 'mc'
  const SHUFFLE_KEY='quiz.shuffle';

  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const els = {
    title: $('#title'), byline: $('#byline'), cat: $('#categorySelect'),
    mode: $('#modeBadge'), shuffle: $('#shuffleToggle'),
    stats: $('#stats'), img: $('#image'), prompt: $('#prompt'),
    freeRow: $('#freeRow'), input: $('#answerInput'),
    mcRow: $('#mcRow'),
    check: $('#checkBtn'), reveal: $('#revealBtn'), next: $('#nextBtn'),
    feedback: $('#feedback'),
    prev: $('#imgPrevBtn'), nextImg: $('#imgNextBtn'), counter: $('#imageCounter'),
    taxaBadge: $('#taxaBadge')
  };

  // ==============================
  // App-state
  // ==============================
  let categories = [];            // från data/categories.json [{id,title,path}]
  let speciesIndex = [];          // masterlista species/index.json
  let speciesById = new Map();    // id -> species

  let data = { title: 'Quiz', questions: [] }; // {title, questions: Question[]}
  let order = [];                 // fråga-index i slumpad/linjär ordning
  let i = 0;                      // position i 'order'
  let score = 0;
  let seen = new Set();           // vilka index som redan poängsatts
  let imgIdx = 0;                 // index i bildkarusell

  // ==============================
  // Settings (läge & blanda)
  // ==============================
  let mode = localStorage.getItem(MODE_KEY) || 'free';
  let shuffle = localStorage.getItem(SHUFFLE_KEY) === '1';
  els.shuffle.checked = shuffle;

  function setMode(m){
    mode = m; localStorage.setItem(MODE_KEY, m);
    els.mode.textContent = 'Läge: ' + (m==='free' ? 'Fritext' : 'Flervalsfråga');
    els.mode.setAttribute('aria-pressed', m==='free' ? 'true' : 'false');
    els.freeRow.style.display = (m==='free')?'flex':'none';
    els.mcRow.style.display = (m==='mc')?'grid':'none';
    els.feedback.textContent = '';
    els.feedback.className = '';
  }
  setMode(mode);

  // ==============================
  // Hjälpfunktioner
  // ==============================
  function normalize(s){
    return (s||'')
      .normalize('NFKC')
      .toLowerCase()
      .replace(/\s+/g,'');
  }
  function isCorrect(input, answers){
    const n = normalize(input);
    return (answers||[]).some(a => normalize(a)===n);
  }
  function registerResult(ok){
    if(ok && !seen.has(order[i])){ score++; seen.add(order[i]); updateStats(); }
  }
  function uniq(arr){ return [...new Set((arr || []).filter(Boolean))]; }

  // Filnamnsvarianter (dina befintliga helpers, något stramade)
  function pathParts(p){
    const m = p.match(/^(.*\/)?([^\/]+)$/); // dir, file
    const dir = (m && m[1]) || '';
    const file = (m && m[2]) || p;
    const m2 = file.match(/^(.*?)(\.[^.]+)?$/);
    const base = m2[1];
    const ext = (m2[2]||'').toLowerCase();
    return {dir, base, ext};
  }
  function extVariants(ext){
    const core = ['.jpg','.jpeg','.png','.webp','.avif'];
    const set = new Set([ext.toLowerCase(), ...core]);
    const out = [];
    set.forEach(e=>{ out.push(e); out.push(e.toUpperCase()); });
    return [...new Set(out)];
  }
  function numberStrippers(base){
    const m = base.match(/^(.*?)(?:[_-]\d+)?$/);
    return m ? m[1] : base;
  }
  function buildVariants(p){
    const {dir, base, ext} = pathParts(p);
    const root = numberStrippers(base);
    const exts = extVariants(ext || '.jpg');
    const names = new Set();
    const push = s => names.add(dir + s);
    const stems = [root, root+'_1', root+'_2', root+'_3', root+'_4', root+'-1', root+'-2', root+'-3', root+'-4'];
    stems.forEach(st => exts.forEach(e => push(st+e)));
    return [...names];
  }

  // ==============================
  // Map & indexering
  // ==============================
  function mapRecordToQuestion(rec){
    const answers = uniq([rec.commonName, rec.latinName, ...(rec.aliases || [])]);
    const images = (rec.images && rec.images.length) ? rec.images : (rec.image ? [rec.image] : []);
    return {
      answers,
      images,
      subgroup: rec.subgroup || rec.group || '',
      group: rec.group || '',
      commonName: rec.commonName || '',
      latinName: rec.latinName || ''
    };
  }

  function getSubgroup(q){
    return q.subgroup || q.group || (q.meta && (q.meta.subgroup || q.meta.group)) || '';
  }

  // Undergruppsindex för MC-distraktorer
  let bySubgroup = new Map();
  function indexBySubgroup(){
    bySubgroup.clear();
    (data.questions || []).forEach(q => {
      const g = getSubgroup(q);
      if(!g) return;
      if(!bySubgroup.has(g)) bySubgroup.set(g, []);
      bySubgroup.get(g).push(q);
    });
  }

  // ==============================
  // Laddning av datafiler
  // ==============================
  async function fetchJson(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`Misslyckades läsa ${url}: ${res.status}`);
    return await res.json();
  }

  async function loadCategoriesOverview(){
    categories = await fetchJson('data/categories.json'); // [{id,title,path}]
    els.cat.innerHTML = '';
    for(const c of categories){
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.title || c.id;
      opt.dataset.path = c.path;
      els.cat.appendChild(opt);
    }
  }

  async function ensureSpeciesIndex(){
    if(speciesIndex.length) return;
    speciesIndex = await fetchJson('data/species/index.json');
    speciesById = new Map(speciesIndex.map(s => [s.id, s]));
  }

  function findCategoryMeta(id){
    return categories.find(c => c.id === id);
  }

  async function loadCategoryAsQuestions(categoryId){
    const meta = findCategoryMeta(categoryId);
    if(!meta) throw new Error(`Okänd kategori: ${categoryId}`);
    const cat = await fetchJson(meta.path); // {id,name,description?,speciesIds:[]}
    const qs = [];
    for(const sid of cat.speciesIds || []){
      const rec = speciesById.get(sid);
      if(!rec){
        console.warn('Saknas i masterlistan:', sid);
        continue;
      }
      qs.push(mapRecordToQuestion(rec));
    }
    data = { title: cat.name || meta.title || cat.id, questions: qs };
    indexBySubgroup();
    buildOrder();
    i = 0;
    imgIdx = 0;
    els.title.textContent = data.title || 'Quiz';
    updateStats();
    await render(); // starta första frågan
  }

  // ==============================
  // Ordning / statistik
  // ==============================
  function sample(arr, k){
    const a=[...arr];
    for(let j=a.length-1;j>0;--j){const r=Math.floor(Math.random()*(j+1)); [a[j],a[r]]=[a[r],a[j]]}
    return a.slice(0,k);
  }

  function buildOrder(){
    order = data.questions.map((_,idx)=>idx);
    if(shuffle){ order = sample(order, order.length); }
    i = 0; score = 0; seen.clear();
  }

  function current(){ return data.questions[order[i]]; }

  function toImagesList(q){
    let candidates = [];
    if(q.images && q.images.length){ candidates = [...q.images]; }
    else if(q.image){ candidates = [q.image]; }
    let enriched = [];
    candidates.forEach(p=>{ enriched.push(p); buildVariants(p).forEach(v=> enriched.push(v)); });
    return [...new Set(enriched)];
  }

  function normalizeQuestion(q){
    if(!q.images || q.images.length===0){ q.images = toImagesList(q); }
    return q;
  }

  function updateStats(){
    els.stats.textContent = `Fråga: ${i+1} / ${order.length} · Poäng: ${score}`;
  }

  async function validateImages(q){
    if(q._validImages) return q._validImages;
    const candidates = toImagesList(q);
    const checks = await Promise.all(
      candidates.map(url => new Promise(res => {
        const img = new Image();
        img.onload = () => res(url);
        img.onerror = () => res(null);
        img.src = url;
      }))
    );
    q._validImages = checks.filter(Boolean);
    return q._validImages;
  }

  function updateCarouselUI(n){
    els.counter.textContent = n? `${imgIdx+1}/${n}` : '';
    const show = n>1 ? 'grid' : 'none';
    els.prev.style.display = show; els.nextImg.style.display = show;
  }

  // ==============================
  // --- DINA (infällda) RENDER-funktioner ---
  // ==============================
  async function showImage(){
    const q = normalizeQuestion(current());
    els.img.alt = 'Laddar bild...';
    const imgs = await validateImages(q);
    const n = imgs.length;
    if(n===0){
      els.img.removeAttribute('src');
      els.img.alt = 'Ingen bild tillgänglig';
      updateCarouselUI(0);
      return;
    }
    imgIdx = (imgIdx + n) % n; // wrap
    els.img.src = imgs[imgIdx];
    els.img.alt = 'Bild: ' + ((q.answers && q.answers[0]) || 'Okänd');
    updateCarouselUI(n);
  }

  function latinFromAnswers(ans){
    if(!ans || !ans.length) return '';
    const latinRegex = /^[A-ZÅÄÖ][a-zåäöéèê\-]+\s+[a-zåäöéèê\-\.]+$/;
    const found = ans.find(a => latinRegex.test(a.trim()));
    if(found) return found;
    return ans[1] || '';
  }

  function primaryCommon(ans){
    if(!ans || !ans.length) return '';
    const latinRegex = /^[A-ZÅÄÖ][a-zåäöéèê\-]+\s+[a-zåäöéèê\-\.]+$/;
    const nonLatin = ans.find(a => !latinRegex.test(a.trim()));
    return nonLatin || ans[0];
  }

  function buildMCChoicesFromSubgroup(q){
    els.mcRow.innerHTML = '';
    const correct = (q.answers && primaryCommon(q.answers)) || '';
    const g = getSubgroup(q);

    // Primär pool: samma undergrupp (exkl. aktuell fråga)
    const sameGroupQs = (bySubgroup.get(g) || []).filter(x => x !== q);
    let poolSame = uniq(
      sameGroupQs
        .map(x => (x.answers && primaryCommon(x.answers)) || '')
        .filter(x => x && x !== correct)
    );

    // Sekundär pool: allt annat i kategorin
    const allOther = data.questions.filter(x => x !== q && getSubgroup(x) !== g);
    let poolOther = uniq(
      allOther
        .map(x => (x.answers && primaryCommon(x.answers)) || '')
        .filter(x => x && x !== correct)
    );

    // 1 rätt + 3 distraktorer
    const need = 3;
    let distractors = sample(poolSame, Math.min(need, poolSame.length));

    if (distractors.length < need) {
      const remaining = need - distractors.length;
      distractors = distractors.concat(sample(poolOther, Math.min(remaining, poolOther.length)));
    }

    // Sista fallback: fyll från alla primära namn, utan dubletter
    if (distractors.length < need) {
      const allPrimary = uniq(
        data.questions
          .filter(x => x !== q)
          .map(x => (x.answers && primaryCommon(x.answers)) || '')
          .filter(Boolean)
      ).filter(x => x !== correct && !distractors.includes(x));
      distractors = distractors.concat(sample(allPrimary, Math.max(0, need - distractors.length)));
    }

    let options = uniq([correct, ...distractors]);
    options = sample(options, options.length); // blanda

    options.forEach(opt =>{
      const id = 'opt_'+Math.random().toString(36).slice(2,8);
      const div = document.createElement('div'); div.className='choice';
      div.innerHTML = `<input type="radio" name="mc" id="${id}" value="${opt}"><label for="${id}">${opt}</label>`;
      els.mcRow.appendChild(div);
    });
  }

  async function render(){
    els.title.textContent = (data.title || 'Quiz');
    updateStats();
    const q = normalizeQuestion(current());
    imgIdx = 0; // reset för ny fråga
    await showImage();
    els.prompt.textContent = 'Vad heter denna art?';
    els.input.value = '';
    els.feedback.textContent = '';
    els.feedback.className = '';

    // taxa badge (diskret)
    const grp = q.group ? q.group : '';
    const sub = q.subgroup ? ` • ${q.subgroup}` : '';
    els.taxaBadge.textContent = (grp || sub) ? `${grp}${sub}` : '';

    // Bygg MC om läge = mc
    if(mode==='mc'){
      buildMCChoicesFromSubgroup(q);
    } else {
      els.mcRow.innerHTML = '';
    }
  }

  // ==============================
  // Event handlers
  // ==============================
  function setFeedback(ok, q){
    if(ok){
      const latin = latinFromAnswers(q.answers);
      els.feedback.textContent = latin ? `Rätt – ${latin}` : 'Rätt!';
      els.feedback.className = 'ok';
    } else {
      els.feedback.textContent = 'Fel';
      els.feedback.className = 'bad';
    }
  }

  function handleCheck(){
    const q = current();
    let ok=false;
    if(mode==='free'){
      ok = isCorrect(els.input.value, q.answers);
    } else {
      const sel = document.querySelector('input[name="mc"]:checked');
      ok = !!sel && isCorrect(sel.value, q.answers);
    }
    setFeedback(ok, q);
    registerResult(ok);
  }

  function handleMCSelection(e){
    if(e.target && e.target.name==='mc'){
      const q = current();
      const ok = isCorrect(e.target.value, q.answers);
      setFeedback(ok, q);
      registerResult(ok);
    }
  }

  function handleReveal(){
    const q = current();
    const common = primaryCommon(q.answers);
    const latin = latinFromAnswers(q.answers);
    els.feedback.textContent = latin ? `Rätt svar: ${common} — ${latin}` : `Rätt svar: ${common}`;
    els.feedback.className = '';
  }

  function handleNext(){
    if(order.length===0) return;
    i = (i+1) % order.length;
    render();
  }

  // Badge: växla läge (utan full reload)
  els.mode.addEventListener('click', () => {
    setMode(mode==='free' ? 'mc' : 'free');
    render();
  });
  els.mode.addEventListener('keydown', (e) => {
    if(e.key===' ' || e.key==='Enter'){ e.preventDefault(); els.mode.click(); }
  });

  // Shuffle: spara, bygg om ordning och rendera om
  els.shuffle.addEventListener('change', (e)=>{
    shuffle = !!e.target.checked; localStorage.setItem(SHUFFLE_KEY, shuffle?'1':'0');
    buildOrder(); i = 0; imgIdx = 0; updateStats(); render();
  });

  // Svarsknappar mm.
  els.check.addEventListener('click', handleCheck);
  els.reveal.addEventListener('click', handleReveal);
  els.next.addEventListener('click', handleNext);
  els.mcRow.addEventListener('change', handleMCSelection);

  // Karusell & tangentbord
  els.prev.addEventListener('click', ()=>{ imgIdx--; showImage(); });
  els.nextImg.addEventListener('click', ()=>{ imgIdx++; showImage(); });
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='ArrowLeft'){ imgIdx--; showImage(); }
    if(ev.key==='ArrowRight'){ imgIdx++; showImage(); }
  });

  // Kategori: ladda vald kategori
  els.cat.addEventListener('change', async () => {
    const id = els.cat.value;
    localStorage.setItem(CATEGORY_KEY, id);
    imgIdx = 0;
    await loadCategoryAsQuestions(id);
  });

  // ==============================
  // Init
  // ==============================
  async function init(){
    try{
      await loadCategoriesOverview();
      await ensureSpeciesIndex();

      // välj initial kategori
      const saved = localStorage.getItem(CATEGORY_KEY);
      const defaultId = saved && categories.some(c=>c.id===saved) ? saved : (categories[0]?.id);
      if(defaultId){ els.cat.value = defaultId; }

      // ladda vald kategori
      if(els.cat.value){
        await loadCategoryAsQuestions(els.cat.value);
      }else{
        data = {title: 'Quiz', questions: []};
        updateStats();
      }
    }catch(err){
      console.error(err);
      els.feedback.textContent = 'Kunde inte ladda data. Kontrollera att data/-filerna finns.';
      els.feedback.className = 'bad';
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  }else{
    init();
  }
})();
</script>
</body>
</html>
